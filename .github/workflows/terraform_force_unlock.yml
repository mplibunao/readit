# Args
# directory: Directory to unlock
# lock_id: The lock id
# /terraform_force_unlock directory=org lock_id=1322132471
name: terraform_force_unlock

defaults:
  run:
    shell: bash

on:
  issue_comment:
    types:
      - created

env:
  TF_VERSION: ~1.3.4

jobs:
  command:
    if: ${{ contains(github.event.comment.body, '/terraform_force_unlock') && github.event.issue.pull_request }}
    runs-on: ubuntu-latest
    outputs:
      directory: ${{ steps.directory.outputs.result }}
      lock_id: ${{ steps.lock_id.outputs.result }}
    steps:
      - name: Checkout
        uses: actions/checkout@v3

      - name: Check command
        id: command
        uses: xt0rted/slash-command-action@v2.0.0
        with:
          repo-token: ${{ secrets.GITHUB_TOKEN }}
          command: terraform_force_unlock
          reaction: 'true'
          reaction-type: 'eyes'

      - name: Get lock id
        uses: actions/github-script@v6
        id: lock_id
        env:
          args: ${{ steps.command.outputs.command-arguments }}
        with:
          script: return /lock_id=([a-zA-Z0-9_-]*)/.exec(process.env.args)[1]
          result-encoding: string

      - name: Get directory
        uses: actions/github-script@v6
        id: directory
        env:
          args: ${{ steps.command.outputs.command-arguments }}
        with:
          script: return /directory=([a-zA-Z0-9_-]*)/.exec(process.env.args)[1]
          result-encoding: string

  terraform_force_unlock:
    needs: command
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: ${{ needs.command.outputs.directory }}
    permissions:
      # Changes the permissions of github token
      # Required for google-github-actions/auth but may set other permissions to none
      # For info on how to configure this, refer to: https://docs.github.com/en/actions/using-workflows/workflow-syntax-for-github-actions#permissions
      # See https://docs.github.com/en/actions/security-guides/automatic-token-authentication#permissions-for-the-github_token for the default permissions
      contents: 'read'
      id-token: 'write'
      # Writing comments
      issues: 'write'
      pull-requests: 'write'
    steps:
      - name: Checkout
        uses: actions/checkout@v3

      - name: Auth GCP Service Account
        id: auth-gcp
        uses: google-github-actions/auth@v1
        with:
          workload_identity_provider: '${{ secrets.GCP_WORKLOAD_IDENTITY_PROVIDER }}'
          service_account: '${{ secrets.GCP_SERVICE_ACCOUNT }}'
          export_environment_variables: true
          create_credentials_file: true
          token_format: 'access_token'
          access_token_lifetime: '1200s'

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v2
        with:
          terraform_version: ${{ env.TF_VERSION }}

      - name: Terraform Init
        id: init
        run: terraform init

      - name: Terraform Force Unlock
        id: unlock
        run: terraform force-unlock -force ${{ needs.command.outputs.lock_id }}

      - name: Comment unlock
        uses: actions/github-script@v6
        env:
          OUTPUT: "terraform\n${{ steps.unlock.outputs.stdout }}"
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const output = `#### Terraform Force Unlock \`${{ steps.unlock.outcome }}\`

            <details><summary>Show Unlock Output</summary>

            \`\`\`hcl\n
            ${process.env.OUTPUT}
            \`\`\`

            </details>

            *Triggered by: @${{ github.actor }}, Action: \`${{ github.event_name }}\`*`;

            github.rest.issues.createComment({
            issue_number: context.issue.number,
            owner: context.repo.owner,
            repo: context.repo.repo,
            body: output
            })

      # Highlights whenever a output fails because the "Terraform Output" step continues on error.
      - name: Terraform Force Unlock Status
        if: steps.unlock.outcome == 'failure'
        run: exit 1
