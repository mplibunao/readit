# /terraform_destroy org
# /terraform_destroy_approve org
name: terraform_destroy

defaults:
  run:
    shell: bash

on:
  issue_comment:
    types:
      - created

env:
  TF_VERSION: ~1.3.4

jobs:
  destroy_command:
    if: ${{ contains(github.event.comment.body, '/terraform_destroy') && github.event.issue.pull_request }}
    runs-on: ubuntu-latest
    outputs:
      directory: ${{ steps.command.outputs.command-arguments }}
    steps:
      - name: Checkout
        uses: actions/checkout@v3

      - name: Check command
        id: command
        uses: xt0rted/slash-command-action@v2.0.0
        with:
          repo-token: ${{ secrets.GITHUB_TOKEN }}
          command: terraform_destroy
          reaction: 'true'
          reaction-type: 'eyes'
          # Only admin users can execute this command
          # https://docs.github.com/en/rest/collaborators/collaborators#review-a-users-permission-level
          permission-level: admin

  destroy_approve_command:
    if: ${{ contains(github.event.comment.body, '/terraform_destroy_approve') }}
    runs-on: ubuntu-latest
    outputs:
      directory: ${{ steps.command.outputs.command-arguments }}
    steps:
      - name: Checkout
        uses: actions/checkout@v3

      - name: Check command
        id: command
        uses: xt0rted/slash-command-action@v2.0.0
        with:
          repo-token: ${{ secrets.GITHUB_TOKEN }}
          command: terraform_destroy_approve
          reaction: 'true'
          reaction-type: 'eyes'
          # Only admin users can execute this command
          # https://docs.github.com/en/rest/collaborators/collaborators#review-a-users-permission-level
          permission-level: admin

  terraform_destroy:
    needs: destroy_command
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: ${{ needs.destroy_command.outputs.directory }}
    permissions:
      # Changes the permissions of github token
      # Required for google-github-actions/auth but may set other permissions to none
      # For info on how to configure this, refer to: https://docs.github.com/en/actions/using-workflows/workflow-syntax-for-github-actions#permissions
      # See https://docs.github.com/en/actions/security-guides/automatic-token-authentication#permissions-for-the-github_token for the default permissions
      contents: 'read'
      id-token: 'write'
      # Writing comments
      issues: 'write'
      pull-requests: 'write'
    steps:
      - name: Checkout
        uses: actions/checkout@v3

      - name: Auth GCP Service Account
        id: auth-gcp
        uses: google-github-actions/auth@v1
        with:
          workload_identity_provider: '${{ secrets.GCP_WORKLOAD_IDENTITY_PROVIDER }}'
          service_account: '${{ secrets.GCP_SERVICE_ACCOUNT }}'
          export_environment_variables: true
          create_credentials_file: true
          token_format: 'access_token'
          access_token_lifetime: '1200s'

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v2
        with:
          terraform_version: ${{ env.TF_VERSION }}

      - name: Terraform Init
        id: init
        run: terraform init

      - name: Terraform destroy
        id: destroy
        run: terraform apply -destroy
        continue-on-error: true

      - name: Comment destroy
        uses: actions/github-script@v6
        env:
          DESTROY: "terraform\n${{ steps.destroy.outputs.stdout }}"
          ERROR: ${{ steps.destroy.outputs.stderr }}
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const output = `#### Terraform Destroy Plan \`${{ steps.destroy.outcome }}\`

            <details><summary>Show Destroy Plan</summary>

            \`\`\`hcl\n
            ${process.env.DESTROY}
            \`\`\`

            </details>

            <details><summary>Show Destroy Errors</summary>

            \`\`\`hcl\n
            ${process.env.ERROR}
            \`\`\`

            </details>

            *Triggered by: @${{ github.actor }}, Action: \`${{ github.event_name }}\`*`;

            github.rest.issues.createComment({
            issue_number: context.issue.number,
            owner: context.repo.owner,
            repo: context.repo.repo,
            body: output
            })

      # Highlights whenever a output fails because the "Terraform Output" step continues on error.
      - name: Terraform Destroy Status
        if: steps.destroy.outcome == 'failure'
        run: exit 1

  terraform_destroy_approve:
    needs: destroy_approve_command
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: ${{ needs.destroy_approve_command.outputs.directory }}
    permissions:
      # Changes the permissions of github token
      # Required for google-github-actions/auth but may set other permissions to none
      # For info on how to configure this, refer to: https://docs.github.com/en/actions/using-workflows/workflow-syntax-for-github-actions#permissions
      # See https://docs.github.com/en/actions/security-guides/automatic-token-authentication#permissions-for-the-github_token for the default permissions
      contents: 'read'
      id-token: 'write'
      # Writing comments
      issues: 'write'
      pull-requests: 'write'
    steps:
      - name: Checkout
        uses: actions/checkout@v3

      - name: Auth GCP Service Account
        id: auth-gcp
        uses: google-github-actions/auth@v0
        with:
          workload_identity_provider: '${{ secrets.GCP_WORKLOAD_IDENTITY_PROVIDER }}'
          service_account: '${{ secrets.GCP_SERVICE_ACCOUNT }}'
          export_environment_variables: true
          create_credentials_file: true
          token_format: 'access_token'
          access_token_lifetime: '1200s'

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v2

      - name: Terraform Init
        id: init
        run: terraform init

      - name: Terraform destroy
        id: destroy
        run: terraform apply -destroy -auto-approve
        continue-on-error: true

      - name: Comment destroy
        uses: actions/github-script@v6
        env:
          DESTROY: '${{ steps.destroy.outputs.stdout }}'
          ERROR: ${{ steps.destroy.outputs.stderr }}
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const output = `#### Terraform Destroy \`${{ steps.destroy.outcome }}\`

            <details><summary>Show Destroy</summary>

            \`\`\`hcl\n
            ${process.env.DESTROY}
            \`\`\`

            </details>

            <details><summary>Show Destroy Errors</summary>

            \`\`\`hcl\n
            ${process.env.ERROR}
            \`\`\`

            </details>


            *Triggered by: @${{ github.actor }}, Action: \`${{ github.event_name }}\`*`;

            github.rest.issues.createComment({
            issue_number: context.issue.number,
            owner: context.repo.owner,
            repo: context.repo.repo,
            body: output
            })

      # Highlights whenever a output fails because the "Terraform Output" step continues on error.
      - name: Terraform Destroy Status
        if: steps.destroy.outcome == 'failure'
        run: exit 1
